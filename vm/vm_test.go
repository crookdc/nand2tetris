package vm

import (
	"reflect"
	"strings"
	"testing"
)

func TestEvaluate(t *testing.T) {
	tests := []struct {
		src      string
		expected []string
	}{
		{
			src: "push constant 0",
			expected: []string{
				"@0",
				"D=A",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push constant 24565",
			expected: []string{
				"@24565",
				"D=A",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push local 17",
			expected: []string{
				"@LCL",
				"D=M",
				"@17",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push local 0",
			expected: []string{
				"@LCL",
				"D=M",
				"@0",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push argument 110",
			expected: []string{
				"@ARG",
				"D=M",
				"@110",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push argument 0",
			expected: []string{
				"@ARG",
				"D=M",
				"@0",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push this 110",
			expected: []string{
				"@THIS",
				"D=M",
				"@110",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push this 0",
			expected: []string{
				"@THIS",
				"D=M",
				"@0",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push that 110",
			expected: []string{
				"@THAT",
				"D=M",
				"@110",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push that 0",
			expected: []string{
				"@THAT",
				"D=M",
				"@0",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push temp 3",
			expected: []string{
				"@8",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "push temp 0",
			expected: []string{
				"@5",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "pop local 17",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@LCL",
				"D=D+M",
				"@17",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
		},
		{
			src: "pop local 0",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@LCL",
				"D=D+M",
				"@0",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
		},
		{
			src: "pop argument 0",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@ARG",
				"D=D+M",
				"@0",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
		},
		{
			src: "pop argument 15",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@ARG",
				"D=D+M",
				"@15",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
		},
		{
			src: "pop this 110",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@THIS",
				"D=D+M",
				"@110",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
		},
		{
			src: "pop this 0",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@THIS",
				"D=D+M",
				"@0",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
		},
		{
			src: "pop that 110",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@THAT",
				"D=D+M",
				"@110",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
		},
		{
			src: "pop that 0",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@THAT",
				"D=D+M",
				"@0",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
		},
		{
			src: "pop temp 3",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@5",
				"D=D+M",
				"@3",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
		},
		{
			src: "pop temp 0",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@5",
				"D=D+M",
				"@0",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
		},
		{
			src: "add",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@SP",
				"AM=M-1",
				"D=D+M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "sub",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@SP",
				"AM=M-1",
				"D=M-D",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "neg",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=-M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "and",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@SP",
				"AM=M-1",
				"D=D&M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "or",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@SP",
				"AM=M-1",
				"D=D|M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "not",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=!M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "eq",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@SP",
				"AM=M-1",
				"D=M-D",
				"@T.1",
				"D;JEQ",
				"D=0",
				"@END.1",
				"0;JMP",
				"(T.1)",
				"D=-1",
				"(END.1)",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "lt",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@SP",
				"AM=M-1",
				"D=M-D",
				"@T.1",
				"D;JLT",
				"D=0",
				"@END.1",
				"0;JMP",
				"(T.1)",
				"D=-1",
				"(END.1)",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "gt",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@SP",
				"AM=M-1",
				"D=M-D",
				"@T.1",
				"D;JGT",
				"D=0",
				"@END.1",
				"0;JMP",
				"(T.1)",
				"D=-1",
				"(END.1)",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "function Pow 2",
			expected: []string{
				"(Main.Pow)",
				// First parameter
				"@0",
				"D=A",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
				// Second parameter
				"@0",
				"D=A",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
		},
		{
			src: "goto LOOP",
			expected: []string{
				"@LOOP",
				"0;JMP",
			},
		},
		{
			src: "if-goto LOOP",
			expected: []string{
				"@SP",
				"AM=M-1",
				"D=M",
				"@LOOP",
				"D;JGT",
			},
		},
	}
	for _, test := range tests {
		t.Run(test.src, func(t *testing.T) {
			actual, err := Translate("Main", strings.NewReader(test.src))
			if err != nil {
				t.Fatal(err)
			}
			if !reflect.DeepEqual(actual, test.expected) {
				t.Errorf("expected %v but got %v", test.expected, actual)
			}
		})
	}
}
