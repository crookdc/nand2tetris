package vm

import (
	"reflect"
	"strings"
	"testing"
)

func TestEvaluate(t *testing.T) {
	tests := []struct {
		src      string
		expected []string
		ok       bool
	}{
		{
			src: "push constant 0",
			expected: []string{
				"@0",
				"D=A",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "push constant 24565",
			expected: []string{
				"@24565",
				"D=A",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "push constant -256",
			ok:  false,
		},
		{
			src: "push constant 32769",
			ok:  false,
		},
		{
			src: "push local 17",
			expected: []string{
				"@LCL",
				"D=M",
				"@17",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "push local 0",
			expected: []string{
				"@LCL",
				"D=M",
				"@0",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "push local -1",
			ok:  false,
		},
		{
			src: "push arg 110",
			expected: []string{
				"@ARG",
				"D=M",
				"@110",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "push arg 0",
			expected: []string{
				"@ARG",
				"D=M",
				"@0",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "push arg -1",
			ok:  false,
		},
		{
			src: "push this 110",
			expected: []string{
				"@THIS",
				"D=M",
				"@110",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "push this 0",
			expected: []string{
				"@THIS",
				"D=M",
				"@0",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "push this -1",
			ok:  false,
		},
		{
			src: "push that 110",
			expected: []string{
				"@THAT",
				"D=M",
				"@110",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "push that 0",
			expected: []string{
				"@THAT",
				"D=M",
				"@0",
				"A=D+A",
				"D=M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "push that -1",
			ok:  false,
		},
		{
			src: "pop local 17",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@LCL",
				"D=D+M",
				"@17",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
			ok: true,
		},
		{
			src: "pop local 0",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@LCL",
				"D=D+M",
				"@0",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
			ok: true,
		},
		{
			src: "pop local -1",
			ok:  false,
		},
		{
			src: "pop arg 0",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@ARG",
				"D=D+M",
				"@0",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
			ok: true,
		},
		{
			src: "pop arg 15",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@ARG",
				"D=D+M",
				"@15",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
			ok: true,
		},
		{
			src: "pop arg -1",
			ok:  false,
		},
		{
			src: "pop this 110",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@THIS",
				"D=D+M",
				"@110",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
			ok: true,
		},
		{
			src: "pop this 0",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@THIS",
				"D=D+M",
				"@0",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
			ok: true,
		},
		{
			src: "pop this -1",
			ok:  false,
		},
		{
			src: "pop that 110",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@THAT",
				"D=D+M",
				"@110",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
			ok: true,
		},
		{
			src: "pop that 0",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@THAT",
				"D=D+M",
				"@0",
				"D=D+A",
				"@SP",
				"A=M",
				"A=M",
				"A=D-A",
				"M=D-A",
			},
			ok: true,
		},
		{
			src: "pop that -1",
			ok:  false,
		},
		{
			src: "add",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@R13",
				"M=D",
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@R13",
				"D=D+M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "sub",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@R13",
				"M=D",
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@R13",
				"D=D-M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "neg",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"D=-D",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "and",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@R13",
				"M=D",
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@R13",
				"D=D&M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "or",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@R13",
				"M=D",
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"@R13",
				"D=D|M",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
		{
			src: "not",
			expected: []string{
				"@SP",
				"M=M-1",
				"A=M",
				"D=M",
				"D=!D",
				"@SP",
				"A=M",
				"M=D",
				"@SP",
				"M=M+1",
			},
			ok: true,
		},
	}
	for _, test := range tests {
		t.Run(test.src, func(t *testing.T) {
			actual, err := Evaluate(strings.NewReader(test.src))
			if (err == nil && !test.ok) || (err != nil && test.ok) {
				t.Errorf("expected non-nil error but got %v", err)
			}
			if !reflect.DeepEqual(actual, test.expected) {
				t.Errorf("expected %v but got %v", test.expected, actual)
			}
		})
	}
}
